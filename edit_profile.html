<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Edit Profile | BulSU MSC</title>
  <link rel="icon" href="./Logos/Bulsu MSC Logo-02.png" type="image/png" />

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400..900&family=Segoe+UI:wght@400;700&display=swap"
    rel="stylesheet">

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <script defer="" src="js/tabs.js"></script>
  <!-- <script src="js/calendar.js" defer></script> -->

  <style>
    @font-face {
      font-family: "Veonika";
      src: url("https://fonts.cdnfonts.com/s/72818/veonika_free.woff") format("woff");
    }

    /* Use Segoe UI for the main title on all devices */
    h1 {
      font-family: "Segoe UI", "Segoe UI Web", "Segoe UI Symbol",
        "Helvetica Neue", "Arial", sans-serif;
    }

    /* Use Orbitron for general headings on mobile, Veonika on desktop for some */
    h2,
    h3 {
      font-family: "Orbitron", sans-serif;
    }

    main,
    body {
      background-color: #080c24;
    }

    #main-header {
      background-color: #00071c;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    #main-header.header-scrolled {
      background-color: #00071c;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.4),
        0 2px 4px -1px rgba(0, 0, 0, 0.4);
    }

    .nav-link {
      color: #d1d5db;
      /* Tailwind grayâ€‘300 */
      transition: color 0.3s;
    }

    .nav-link:hover {
      color: #b9da05;
    }

    .nav-icon-wrapper {
      width: 2.5rem;
      height: 2.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: transparent;
      transition: all 0.3s;
      cursor: pointer;
    }

    .nav-icon-wrapper:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }

    .nav-icon {
      color: white;
      font-size: 1.25rem;
      /* text-xl */
      transition: transform 0.3s, color 0.3s;
    }

    .nav-icon-wrapper:hover .nav-icon {
      color: #b9da05;
      transform: scale(1.1);
    }

    /* Toast notification*/
    @keyframes slide-in {
      0% {
        opacity: 0;
        transform: translateY(20px);
      }

      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .animate-slide-in {
      animation: slide-in 0.4s ease-out;
    }

    /* Custom scrollbar styles */
    ::-webkit-scrollbar {
      width: 8px;
      background-color: #1e293b;
      /* bg-slate-800 */
    }

    ::-webkit-scrollbar-thumb {
      background-color: #b9da05;
      /* green-400 */
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background-color: #d1d5db;
      /* gray-300 */
    }
  </style>
</head>

<body class="bg-gray-100">
  <nav id="main-header" class="fixed top-0 left-0 right-0 z-50 transition-all duration-300 ease-in-out py-4">
    <div class="max-w-7xl mx-auto px-4 flex justify-between items-center">
      <a href="index.html"
        class="flex items-center space-x-2 text-white transition-colors duration-300 hover:text-[#b9da05]">
        <img src="./Logos/Bulsu MSC Logo-02.png" alt="BULSU MSC Logo" class="h-12" />
      </a>
      <div class="hidden md:flex items-center space-x-8">
        <a href="dashboard.html" class="nav-link cursor-pointer font-semibold">Home</a>
        <a href="announcements.html" class="nav-link cursor-pointer font-semibold">Announcements</a>
        <a href="events-and-register-events.html" class="nav-link cursor-pointer font-semibold">Events</a>

        <a href="#" class="nav-icon-wrapper">
          <i class="fa-solid fa-circle-user nav-icon"></i>
        </a>

        <a href="calendar.html" class="nav-icon-wrapper">
          <i class="fa-solid fa-calendar-days nav-icon"></i>
        </a>

        <a href="settings.html" class="nav-icon-wrapper">
          <i class="fa-solid fa-gear nav-icon"></i>
        </a>

      </div>
      <div class="md:hidden flex items-center space-x-4">
        <button id="mobile-menu-button" class="text-gray-300 hover:text-[#b9da05] focus:outline-none">
          <i id="mobile-menu-icon" class="fas fa-bars text-2xl transition-transform duration-300"></i>
        </button>
      </div>
    </div>
  </nav>

  <!-- Mobile Sidebar -->
  <div id="mobile-sidebar"
    class="fixed top-[64px] left-0 w-64 h-[calc(100%-64px)] bg-[#00071c] bg-opacity-90 backdrop-blur-md z-40 transform -translate-x-full transition-transform duration-300 ease-in-out md:hidden">
    <div class="p-6 space-y-4 text-white font-semibold">
      <a href="dashboard.html"
        class="flex items-center space-x-4 p-2 rounded-md group hover:bg-white/10 transition-colors duration-300 cursor-pointer">
        <i
          class="fa-solid fa-house text-xl w-6 text-center group-hover:text-[#b9da05] group-hover:scale-110 transition-all duration-300">
        </i>
        <span>Home</span>
      </a>

      <a href="announcements.html"
        class="flex items-center space-x-4 p-2 rounded-md group hover:bg-white/10 transition-colors duration-300 cursor-pointer">
        <i
          class="fa-solid fa-bell text-xl w-6 text-center group-hover:text-[#b9da05] group-hover:scale-110 transition-all duration-300"></i>
        <span>Announcements</span>
      </a>

      <a href="events-and-register-events.html"
        class="flex items-center space-x-4 p-2 rounded-md group hover:bg-white/10 transition-colors duration-300 cursor-pointer">
        <i
          class="fa-solid fa-calendar-alt text-xl w-6 text-center group-hover:text-[#b9da05] group-hover:scale-110 transition-all duration-300"></i>
        <span>Events</span>
      </a>

      <a href="edit_profile.html"
        class="flex items-center space-x-4 p-2 rounded-md group hover:bg-white/10 transition-colors duration-300 cursor-pointer">
        <i
          class="fa-solid fa-user-circle text-xl w-6 text-center group-hover:text-[#b9da05] group-hover:scale-110 transition-all duration-300"></i>
        <span>Edit Profile</span>
      </a>

      <a href="calendar.html"
        class="flex items-center space-x-4 p-2 rounded-md group hover:bg-white/10 transition-colors duration-300 cursor-pointer">
        <i
          class="fa-solid fa-calendar-days text-xl w-6 text-center group-hover:text-[#b9da05] group-hover:scale-110 transition-all duration-300"></i>
        <span>Calendar</span>
      </a>

      <a href="settings.html"
        class="flex items-center space-x-4 p-2 rounded-md group hover:bg-white/10 transition-colors duration-300 cursor-pointer">
        <i
          class="fa-solid fa-gear text-xl w-6 text-center group-hover:text-[#b9da05] group-hover:scale-110 transition-all duration-300"></i>
        <span>Settings</span>
      </a>
    </div>
  </div>

  <main class="pt-28 flex justify-center">
    <section id="header"
      class="w-[96%] mx-auto mb-8 bg-transparent flex flex-col lg:flex-row gap-5 items-stretch rounded min-h-[calc(100vh-7rem)]">

      <!-- Left Section: Profile -->
      <div class="w-full lg:w-2/6 rounded-lg bg-[#011538] border border-[#b9da05] self-stretch">
        <div class="px-4 sm:px-6 py-4">
          <div class="mb-4 text-right w-full">
            <h4 class="text-xs md:text-sm font-semibold uppercase tracking-wider text-white py-2 px-2" id="msc_id">
            </h4>
          </div>

          <div>
            <div class="w-28 h-28 mx-auto mb-4 rounded-full shadow-md overflow-hidden" id="profile-picture-container">
              <!-- Default: Profile pic thru user's initials -->
            </div>
          </div>

          <div class="flex flex-col items-center justify-center text-center">
            <h2 class="text-3xl text-white font-bold mb-1" id="fullName"></h2>
            <p class="text-sm text-white mb-6" id="studentID"></p>
          </div>

          <div class="w-full h-px bg-white my-4"></div>

          <div class="text-center mb-6 w-full">
            <h3 class="text-white text-lg font-bold" id="program"></h3>
            <p class="text-white" id="college"></p>
            <p class="text-white" id="year_level"></p>
          </div>

          <div class="flex flex-col items-center justify-center text-center">
            <div class="mb-4 w-32 h-32 bg-white p-1 rounded-lg flex items-center justify-center">
              <!-- Dyamic QR Code -->
              <div id="qr-code" class="w-full h-full"></div>
            </div>

            <!-- <p class="text-sm text-blue-200 mb-6">ID No. </p> -->

            <div class="flex gap-2 mt-4">
              <span class="bg-[#03850a] text-white px-4 py-1 rounded-full text-xs">
                Active
              </span>
              <span class="bg-[#03378f] text-white px-4 py-1 rounded-full text-xs" id="role">
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Section: Edit Profile -->
      <div class="w-full lg:w-4/5 flex flex-col self-stretch h-full">

        <!-- Personal Info -->
        <div
          class="w-full rounded-lg shadow-md bg-[#011538] border border-[#b9da05] text-white overflow-hidden flex-shrink-0">
          <div class="bg-[#011538] flex flex-row flex-wrap items-center justify-between px-4 sm:px-6 pt-6 pb-2 gap-2">
            <h2 class="text-xl font-bold text-white">
              Personal Information
            </h2>

            <!-- Save Button: disabled (default) -->
            <div class="flex gap-2 mt-2 sm:mt-0">
              <button id="saveBtn"
                class="text-gray-400 hover:text-[#b9da05] transition-colors pointer-events-none opacity-50"
                onclick="updateProfile()" title="Save changes">
                <i class="fas fa-save w-4 h-4"></i>
              </button>
            </div>

          </div>

          <div class="bg-[#011538] pt-4 px-4 sm:px-6 pb-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-y-4 gap-x-6">

              <div class="md:col-span-2">
                <h3 class="text-[#b9da05] text-md font-semibold mb-2">Personal Details</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-y-4 gap-x-6">
                  <div>
                    <h3 class="text-white text-sm mb-1">First Name:</h3>
                    <input type="text" value=""
                      class="w-full p-2 rounded-md bg-[#27272a] border border-gray-600 text-white placeholder-gray-400 mb-4 focus:outline-none focus:ring-2 focus:ring-[#b9da05]"
                      id="firstName" />
                  </div>
                  <div>
                    <h3 class="text-white text-sm mb-1">Middle Name:</h3>
                    <input type="text" value=""
                      class="w-full p-2 rounded-md bg-[#27272a] border border-gray-600 text-white placeholder-gray-400 mb-4 focus:outline-none focus:ring-2 focus:ring-[#b9da05]"
                      id="middleName" />
                  </div>
                  <div>
                    <h3 class="text-white text-sm mb-1">Last Name:</h3>
                    <input type="text" value=""
                      class="w-full p-2 rounded-md bg-[#27272a] border border-gray-600 text-white placeholder-gray-400 mb-4 focus:outline-none focus:ring-2 focus:ring-[#b9da05]"
                      id="lastName" />
                  </div>
                  <div>
                    <h3 class="text-white text-sm mb-1">Name Suffix:</h3>
                    <select name=""
                      class="w-full p-2 rounded-md bg-[#27272a] border border-gray-600 text-white placeholder-gray-400 mb-4 focus:outline-none focus:ring-2 focus:ring-[#b9da05]"
                      id="name_suffix">
                      <option value="">None</option>
                      <option value="Jr.">Jr.</option>
                      <option value="Sr.">Sr.</option>
                      <option value="I">I</option>
                      <option value="II">II</option>
                      <option value="III">III</option>
                      <option value="IV">IV</option>
                      <option value="V">V</option>
                    </select>
                  </div>
                </div>
              </div>

              <div class="md:col-span-2 border-t border-gray-200 my-1"></div>

              <div class="md:col-span-2">
                <h3 class="text-[#b9da05] text-md font-semibold mb-2">Demographic Information</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-y-4 gap-x-6">
                  <div>
                    <h3 class="text-white text-sm mb-1">Date of Birth:</h3>
                    <input type="date" value=""
                      class="w-full p-2 rounded-md bg-[#27272a] border border-gray-600 text-white placeholder-gray-400 mb-4 focus:outline-none focus:ring-2 focus:ring-[#b9da05]"
                      id="birthdate" />
                  </div>
                  <div>
                    <h3 class="text-white text-sm mb-1">Gender:</h3>
                    <select
                      class="w-full p-2 rounded-md bg-[#27272a] border border-gray-600 text-white placeholder-gray-400 mb-4 focus:outline-none focus:ring-2 focus:ring-[#b9da05]"
                      id="gender">
                      <option value="">Select Gender</option>
                      <option value="Male">Male</option>
                      <option value="Female">Female</option>
                    </select>
                  </div>
                </div>
              </div>

              <div class="md:col-span-2 border-t border-gray-200 my-1"></div>

              <div class="md:col-span-2">
                <h3 class="text-[#b9da05] text-md font-semibold mb-2">Contact Information</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-y-4 gap-x-6">
                  <div>
                    <h3 class="text-white text-sm mb-1">Email:</h3>
                    <input type="" value="" placeholder=""
                      class="w-full p-2 rounded-md bg-[#27272a] border border-gray-600 text-white placeholder-gray-400 mb-4 focus:outline-none focus:ring-2 focus:ring-[#b9da05]"
                      id="email" disabled />
                  </div>
                  <div>
                    <h3 class="text-white text-sm mb-1">Phone:</h3>
                    <input type="tel" value="" placeholder=""
                      class="w-full p-2 rounded-md bg-[#27272a] border border-gray-600 text-white placeholder-gray-400 mb-4 focus:outline-none focus:ring-2 focus:ring-[#b9da05]"
                      id="phone" />
                  </div>
                  <div class="md:col-span-2">
                    <h3 class="text-white text-sm mb-2">Address:</h3>
                    <input type="text" value=""
                      class="w-full p-2 rounded-md bg-[#27272a] border border-gray-600 text-white placeholder-gray-400 mb-4 focus:outline-none focus:ring-2 focus:ring-[#b9da05]"
                      id="address" />
                  </div>
                  <div>
                    <h3 class="text-white text-sm mb-2">Facebook Username:</h3>
                    <input type="text" value="" placeholder=""
                      class="w-full p-2 rounded-md bg-[#27272a] border border-gray-600 text-white placeholder-gray-400 mb-4 focus:outline-none focus:ring-2 focus:ring-[#b9da05]"
                      id="facebook_link" />
                  </div>
                </div>
              </div>

              <div class="md:col-span-2 border-t border-gray-200 my-1"></div>

              <div class="md:col-span-2">
                <h3 class="text-[#b9da05] text-md font-semibold mb-2">Academic Information</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-y-4 gap-x-6">
                  <div>
                    <h3 class="text-white text-sm mb-1">College:</h3>
                    <select id="student_college"
                      class="w-full p-2 rounded-md bg-[#27272a] border border-gray-600 text-white placeholder-gray-400 mb-4 focus:outline-none focus:ring-2 focus:ring-[#b9da05]">
                      <option value="">Select College</option>
                    </select>
                  </div>

                  <div>
                    <h3 class="text-white text-sm mb-1">Program:</h3>
                    <select id="student_program"
                      class="w-full p-2 rounded-md bg-[#27272a] border border-gray-600 text-white placeholder-gray-400 mb-4 focus:outline-none focus:ring-2 focus:ring-[#b9da05]">
                      <option value="">Select Program</option>
                    </select>
                  </div>

                  <div>
                    <h3 class="text-white text-sm mb-1">Section:</h3>
                    <input type="text" value=""
                      class="w-full p-2 rounded-md bg-[#27272a] border border-gray-600 text-white placeholder-gray-400 mb-4 focus:outline-none focus:ring-2 focus:ring-[#b9da05]"
                      id="section" />
                  </div>
                  <div>
                    <h3 class="text-white text-sm mb-1">Student No:</h3>
                    <input type="text" value=""
                      class="w-full p-2 rounded-md bg-[#27272a] border border-gray-600 text-white placeholder-gray-400 mb-4 cursor-not-allowed"
                      disabled id="student_no" />
                  </div>
                </div>
              </div>

              <div class="md:col-span-2 border-t border-gray-200 my-1"></div>

              <div class="md:col-span-2">
                <h3 class="text-[#b9da05] text-md font-semibold mb-2">Account Information</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-y-4 gap-x-6">
                  <div>
                    <h3 class="text-white text-sm mb-1">Username:</h3>
                    <input type="" value="" placeholder=""
                      class="w-full p-2 rounded-md bg-[#27272a] border border-gray-600 text-white placeholder-gray-400 mb-4 cursor-not-allowed"
                      id="username" disabled />
                  </div>
                  <div>
                    <h3 class="text-white text-sm mb-1">Member Since:</h3>
                    <p class="font-medium text-white" id="member_since"></p>
                  </div>

                  <div class="space-y-2">
                    <label for="profile" class="text-white text-sm mb-1 block">
                      Change Profile Picture:
                    </label>
                    <input type="file" id="profile" class="block w-full text-sm text-white file:mr-4 file:py-2 file:px-4
         file:rounded-md file:border-0 file:text-sm file:font-semibold
         file:bg-[#b9da05] file:text-black hover:file:bg-[#a5c604]
         bg-[#27272a] border border-gray-600 rounded-md
         focus:outline-none focus:ring-2 focus:ring-[#b9da05]
         transition duration-150 ease-in-out" accept="image/*" />
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>

        <!-- Toast Notification: Updated/Failed -->
        <div id="toast" class="fixed bottom-6 right-6 z-50 hidden">
          <div id="toast-content"
            class="flex items-center max-w-xs p-4 text-sm text-white bg-green-600 rounded-lg shadow-lg animate-slide-in"
            role="alert">
            <i class="fas fa-check-circle mr-2 text-white"></i>
            <div id="toast-message"></div>
          </div>
        </div>

        <div class="bg-[#011538] border border-[#b9da05] rounded-xl my-6 shadow-lg max-w-full flex-grow flex flex-col">

          <div class="pb-2 pt-6 px-4 sm:px-6">
            <h2 class="text-xl font-bold text-white flex items-center justify-between">
              <span>Attended Events & Badges</span>
            </h2>
          </div>

          <!-- Scrollable container -->
          <div class="pt-2 px-4 sm:px-6 pb-4 overflow-y-auto flex-grow">
            <div class="text-center">
              <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 py-2" id="badgeContainer">
                <div
                  class="flex flex-col items-center p-4 sm:p-6 bg-[#00112F] border border-white/50 rounded-2xl shadow-md hover:shadow-lg transition-shadow duration-300">
                  <div class="w-14 h-14 flex items-center justify-center bg-yellow-100 rounded-full mb-3">
                    <i class="fas fa-medal text-yellow-500 text-xl"></i>
                  </div>
                  <h3 class="text-base font-semibold text-white">
                    Exclusive Member
                  </h3>
                  <p class="text-sm text-white mt-1" id="member_since2"></p>
                </div>
                <!-- Dynamic badges append here -->
              </div>
            </div>
          </div>
        </div>
        <!-- <div class="pt-2 pb-6 flex justify-center">
                <button
                  class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded flex items-center"
                >
                  <i class="fas fa-wallet mr-2 h-4 w-4"></i>
                  View Badge Wallet
                </button>
              </div> -->
      </div>
    </section>
  </main>

  <footer class="bg-[#00071c] text-center p-6 border-t border-gray-800">
    <div class="flex justify-center space-x-1 mb-1">
      <a href="https://www.bulsu.edu.ph" target="_blank" rel="noopener noreferrer"><img src="./Logos/BulSU.png"
          alt="Bulacan State University Logo" class="h-10"></a>
      <a href="https://www.facebook.com/osobulsu" target="_blank" rel="noopener noreferrer"><img src="./Logos/OSOA.png"
          alt="Bulacan State University OSOA Logo" class="h-10 w-10"></a>
    </div>
    <p class="text-gray-500 text-sm">&copy; 2025 BulSU Microsoft Student Community. All rights reserved.</p>
    <div class="flex justify-center space-x-4 mt-2">
      <a href="https://www.facebook.com/bulsu.officialmsc" target="_blank"
        class="text-gray-400 hover:text-[#b9da05] transition-colors duration-300"><i class="fab fa-facebook-f"></i></a>
      <a href="https://www.instagram.com/bulsumsc/" target="_blank"
        class="text-gray-400 hover:text-[#b9da05] transition-colors duration-300"><i class="fab fa-instagram"></i></a>
      <a href="https://www.threads.com/@bulsumsc" target="_blank"
        class="text-gray-400 hover:text-[#b9da05] transition-colors duration-300"><i class="fab fa-threads"></i></a>
      <a href="https://www.tiktok.com/@bulsumsc" target="_blank"
        class="text-gray-400 hover:text-[#b9da05] transition-colors duration-300"><i class="fab fa-tiktok"></i></a>
      <a href="https://www.linkedin.com/company/bulsumsc/" target="_blank"
        class="text-gray-400 hover:text-[#b9da05] transition-colors duration-300"><i class="fab fa-linkedin"></i></a>
      <a href="https://www.github.com/bulsumsc" target="_blank"
        class="text-gray-400 hover:text-[#b9da05] transition-colors duration-300"><i class="fab fa-github"></i></a>
    </div>
  </footer>



  <script>
    const API_BASE = "/updated-msc-website/api";

    async function apiCall(endpoint, method = "GET", data = null) {
      try {
        const options = {
          method,
          headers: { "Content-Type": "application/json" },
          credentials: "include",
        };

        if (data) options.body = JSON.stringify(data);

        const response = await fetch(`${API_BASE}${endpoint}`, options);
        return await response.json();
      } catch (error) {
        console.error("API Error:", error);
        return null;
      }
    }

    // Mobile View: Sidebar
    const menuButton = document.getElementById("mobile-menu-button");
    const mobileSidebar = document.getElementById("mobile-sidebar");

    if (menuButton && mobileSidebar) {
      menuButton.addEventListener("click", () => {
        mobileSidebar.classList.toggle("-translate-x-full");
      });

      document.addEventListener("click", function (event) {
        const isClickInsideSidebar = mobileSidebar.contains(event.target);
        const isClickOnMenu = menuButton.contains(event.target);

        if (!isClickInsideSidebar && !isClickOnMenu) {
          mobileSidebar.classList.add("-translate-x-full");
        }
      });
    }

    let originalProfile = {};
    const collegeProgramMap = {
      "College of Architecture and Fine Arts (CAFA)": [
        "BS Architecture",
        "B Landscape Architecture",
        "B Fine Arts Major in Visual Communication",
      ],
      "College of Arts and Letters (CAL)": [
        "BA Broadcasting",
        "BA Journalism",
        "B Performing Arts (Theater Track)",
        "B Sining sa Malikhaing Pagsulat",
      ],
      "College of Business Education and Accountancy (CBEA)": [
        "BS Accountancy",
        "BS Business Administration Major in Business Economics",
        "BS Business Administration Major in Financial Management",
        "BS Business Administration Major in Marketing Management",
        "BS Entrepreneurship",
      ],
      "College of Criminal Justice Education (CCJE)": [
        "BS Criminology",
        "BA Legal Management",
      ],
      "College of Hospitality and Tourism Management (CHTM)": [
        "BS Hospitality Management",
        "BS Tourism Management",
      ],
      "College of Information and Communications Technology (CICT)": [
        "BS Information Technology",
        "BS Information System",
        "B Library and Information Science",
      ],
      "College of Industrial Technology (CIT)": [
        "BIT with specialization in Automotive",
        "BIT with specialization in Computer",
        "BIT with specialization in Drafting",
        "BIT with specialization in Electrical",
        "BIT with specialization in Electronics & Communication Technology",
        "BIT with specialization in Electronics Technology",
        "BIT with specialization in Food Processing Technology",
        "BIT with specialization in Heating, Ventilation, Air Conditioning and Refrigeration Technology (HVACR)",
        "BIT with specialization in Mechanical",
        "BIT with specialization in Mechatronics Technology",
        "BIT with specialization in Welding Technology",
      ],
      "College of Nursing (CON)": ["BS Nursing"],
      "College of Engineering (COE)": [
        "BS Civil Engineering",
        "BS Computer Engineering",
        "BS Electrical Engineering",
        "BS Electronics Engineering",
        "BS Industrial Engineering",
        "BS Manufacturing Engineering",
        "BS Mechanical Engineering",
        "BS Mechatronics Engineering",
      ],
      "College of Education (COED)": [
        "B Early Childhood Education",
        "B Elementary Education",
        "B Physical Education",
        "BSEd Major in English Minor in Mandarin",
        "BSEd in Filipino",
        "BSEd in Mathematics",
        "BSEd in Sciences",
        "BSEd in Social Studies",
        "BSEd in Values Education",
        "BTLEd Major in Home Economics",
        "BTLEd Major in Industrial Arts",
        "BTLEd Major in Information and Communication Technology",
      ],
      "College of Science (CS)": [
        "BS Biology",
        "BS Environmental Science",
        "BS Food Technology",
        "BS Math with Specialization in Applied Statistics",
        "BS Math with Specialization in Business Applications",
        "BS Math with Specialization in Computer Science",
      ],
      "College of Sports, Exercise and Recreation (CSER)": [
        "BS ESS with specialization in Fitness and Sports Coaching",
        "BS ESS with specialization in Fitness and Sports Management",
      ],
      "College of Social Sciences and Philosophy (CSSP)": [
        "B Public Administration",
        "BS Psychology",
        "BS Social Work",
      ]
    };

    const collegeSelect = document.getElementById('student_college');
    const programSelect = document.getElementById('student_program');

    function populateColleges(selectedCollege = "") {
      collegeSelect.innerHTML = '<option value="">Select College</option>';
      Object.keys(collegeProgramMap).forEach(college => {
        const option = document.createElement('option');
        option.value = college;
        option.textContent = college;
        if (college === selectedCollege) option.selected = true;
        collegeSelect.appendChild(option);
      });
    }

    function populatePrograms(selectedCollege, selectedProgram = "") {
      programSelect.innerHTML = '<option value="">Select Program</option>';

      if (selectedCollege && collegeProgramMap[selectedCollege]) {
        collegeProgramMap[selectedCollege].forEach(program => {
          const option = document.createElement('option');
          option.value = program;
          option.textContent = program;
          if (program === selectedProgram) option.selected = true;
          programSelect.appendChild(option);
        });
      }
    }

    collegeSelect.addEventListener('change', (e) => {
      populatePrograms(e.target.value);
    });

    async function fetchProfile() {
      try {
        const data = await apiCall("/auth/profile");
        if (!data || !data.success) throw new Error("Failed to fetch profile");

        const user = data.data;
        originalProfile = { ...user };

        fetchAndDisplayEventBadges(user.id);

        // Text fields
        document.getElementById("msc_id").textContent = user.msc_id;
        generateQRCode(user.msc_id || user.student_no || "UNKNOWN");
        document.getElementById("fullName").textContent = `${user.first_name} ${user.last_name}`;
        document.getElementById("studentID").textContent = user.student_no;
        document.getElementById("program").textContent = user.program;
        document.getElementById("college").textContent = user.college;
        document.getElementById("year_level").textContent = user.year_level;
        document.getElementById("role").textContent = user.role;

        document.getElementById("firstName").value = user.first_name || "";
        document.getElementById("middleName").value = user.middle_name || "";
        document.getElementById("lastName").value = user.last_name || "";
        document.getElementById("name_suffix").value = user.name_suffix || "";
        document.getElementById("birthdate").value = formatDateInput(user.birthdate);
        document.getElementById("gender").value = user.gender || "";
        document.getElementById("student_no").value = user.student_no || "";
        document.getElementById("section").value = user.section || "";
        document.getElementById("address").value = user.address || "";
        document.getElementById("phone").value = user.phone || "";
        document.getElementById("facebook_link").value = user.facebook_link || "";
        document.getElementById("username").value = user.username || "";
        document.getElementById("email").value = user.email || "";

        // Populate and pre-select college + program
        populateColleges(user.college || "");
        populatePrograms(user.college || "", user.program || "");

        // Member since
        const createdDate = new Date(user.created_at);
        document.getElementById("member_since").textContent = createdDate.toLocaleDateString("en-US", {
          year: "numeric", month: "long", day: "numeric"
        });
        document.getElementById("member_since2").textContent = createdDate.toLocaleDateString("en-US");

        // Profile picture initials
        const initials = `${user.first_name?.charAt(0) || ""}${user.last_name?.charAt(0) || ""}`.toUpperCase();
        renderProfilePicture(user.profile_image_path, initials);

        attachChangeListeners();
        document.documentElement.classList.remove("loading");
      } catch (err) {
        console.error("Failed to fetch user profile:", err);
      }
    }

    // Format YYYY-MM-DD
    function formatDateInput(dateStr) {
      if (!dateStr) return "";
      const date = new Date(dateStr);
      return date.toISOString().split("T")[0];
    }

    function hasProfileChanged() {
      const imageChanged = document.getElementById("profile")?.files.length > 0;

      const fieldChanged = [
        ["firstName", "first_name"],
        ["middleName", "middle_name"],
        ["lastName", "last_name"],
        ["name_suffix", "name_suffix"],
        ["birthdate", "birthdate"],
        ["gender", "gender"],
        ["student_no", "student_no"],
        ["student_college", "college"],
        ["student_program", "program"],
        ["section", "section"],
        ["address", "address"],
        ["phone", "phone"],
        ["facebook_link", "facebook_link"]
      ].some(([id, field]) => {
        const element = document.getElementById(id);
        const currentValue = (element?.value || "").trim();
        const originalValue = (originalProfile[field] || "").trim();
        return currentValue !== originalValue;
      });

      return fieldChanged || imageChanged;
    }

    function attachChangeListeners() {
      const fields = document.querySelectorAll("input, select");
      const saveBtn = document.getElementById("saveBtn");

      fields.forEach(input => {
        input.addEventListener("input", () => {
          if (hasProfileChanged()) {
            saveBtn.classList.remove("pointer-events-none", "opacity-50");
          } else {
            saveBtn.classList.add("pointer-events-none", "opacity-50");
          }
        });
      });

      const fileInput = document.getElementById("profile");
      if (fileInput) {
        fileInput.addEventListener("change", () => {
          if (hasProfileChanged()) {
            saveBtn.classList.remove("pointer-events-none", "opacity-50");
          } else {
            saveBtn.classList.add("pointer-events-none", "opacity-50");
          }

          const file = fileInput.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
              const container = document.getElementById("profile-picture-container");
              container.innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover" />`;
            };
            reader.readAsDataURL(file);
          }
        });
      }
    }

    async function updateProfile() {
      const saveBtn = document.getElementById("saveBtn");

      if (!hasProfileChanged()) {
        showToast("No changes made to profile.", "error");
        return;
      }

      try {
        const profileData = await apiCall("/auth/profile");
        if (!profileData || !profileData.success) {
          alert("Session expired. Please login again.");
          window.location.href = "login.html";
          return;
        }

        const user = profileData.data;
        const studentId = user.id;

        // Upload profile picture separately (if changed)
        const fileInput = document.getElementById("profile");
        let uploadedImagePath = user.profile_image_path;

        if (fileInput && fileInput.files.length > 0) {
          uploadedImagePath = await uploadProfilePicture(studentId);
          if (!uploadedImagePath) {
            showToast("Failed to upload image", "error");
            return;
          }
        }

        const payload = {
          first_name: document.getElementById("firstName").value.trim(),
          middle_name: document.getElementById("middleName").value.trim(),
          last_name: document.getElementById("lastName").value.trim(),
          name_suffix: document.getElementById("name_suffix").value.trim(),
          birthdate: document.getElementById("birthdate").value,
          gender: document.getElementById("gender").value,
          student_no: document.getElementById("student_no").value.trim(),
          year_level: user.year_level,
          college: document.getElementById("student_college").value.trim(),
          program: document.getElementById("student_program").value.trim(),
          section: document.getElementById("section").value.trim(),
          address: document.getElementById("address").value.trim(),
          phone: document.getElementById("phone").value.trim(),
          facebook_link: document.getElementById("facebook_link").value.trim(),
          profile_image_path: uploadedImagePath || null
        };

        const updateResult = await apiCall(`/students/profile/${studentId}`, "PUT", payload);

        if (updateResult && updateResult.success) {
          showToast("Profile updated successfully!", "success");

          originalProfile = { ...originalProfile, ...payload };

          // Disable Save button
          saveBtn.classList.add("pointer-events-none", "opacity-50");

          // Reload after toast disappears
          setTimeout(() => {
            location.reload();
          }, 1500);
        } else {
          console.error(updateResult?.message || "Unknown error");
          showToast("Failed to update profile.", "error");
        }

      } catch (err) {
        console.error("Error updating profile:", err);
        showToast("An error occurred while updating profile.", "error");
      }
    }

    //Profile Pic Generator
    function renderProfilePicture(profilePictureUrl, initials) {
      const container = document.getElementById("profile-picture-container");
      if (!container) return;

      container.innerHTML = "";

      if (profilePictureUrl) {
        const img = document.createElement("img");

        let fullUrl = profilePictureUrl;
        if (profilePictureUrl.startsWith("/uploads")) {
          fullUrl = `${API_BASE.replace("/api", "")}${profilePictureUrl}`;
        }

        img.src = fullUrl;
        img.alt = "Profile Picture";
        img.className = "w-full h-full object-cover";
        container.appendChild(img);
      } else {
        const div = document.createElement("div");
        div.className =
          "w-full h-full rounded-full bg-[#03378f] text-white flex items-center justify-center text-4xl font-bold";
        div.textContent = initials;
        container.appendChild(div);
      }
    }

    function generateQRCode(data) {
      const qrContainer = document.getElementById("qr-code");
      qrContainer.innerHTML = ""; // Clear previous QR

      new QRCode(qrContainer, {
        text: data,
        width: 120,
        height: 120,
        colorDark: "#06047b",
        colorLight: "#ffffff",
        correctLevel: QRCode.CorrectLevel.H,
      });
    }

    document.addEventListener("DOMContentLoaded", fetchProfile);

    async function fetchAndDisplayEventBadges(studentId) {
      try {
        const data = await apiCall(`/events/student/${studentId}`);

        if (data && data.success && Array.isArray(data.data)) {
          const events = data.data;
          const badgeContainer = document.getElementById("badgeContainer");

          const staticBadge = badgeContainer.firstElementChild;

          while (badgeContainer.children.length > 1) {
            badgeContainer.removeChild(badgeContainer.lastChild);
          }

          const attendedEvents = events.filter(ev => ev.attendance_status === "registered");

          const badgeIcons = [
            { icon: "fa-certificate", color: "text-green-500", bg: "bg-green-100" },
            { icon: "fa-trophy", color: "text-yellow-500", bg: "bg-yellow-100" },
            { icon: "fa-star", color: "text-blue-500", bg: "bg-blue-100" },
            { icon: "fa-medal", color: "text-purple-500", bg: "bg-purple-100" },
          ];

          attendedEvents.forEach(ev => {
            const randomIcon = badgeIcons[Math.floor(Math.random() * badgeIcons.length)];

            const card = document.createElement("div");
            card.className =
              "flex flex-col items-center p-6 bg-[#011538] border border-white/20 rounded-2xl shadow-md hover:shadow-lg transition-shadow duration-300";

            card.innerHTML = `
            <div class="w-14 h-14 flex items-center justify-center ${randomIcon.bg} rounded-full mb-3">
              <i class="fas ${randomIcon.icon} ${randomIcon.color} text-xl"></i>
            </div>
            <h3 class="text-base font-semibold text-white truncate">${ev.event_name}</h3>
            <p class="text-sm text-white mt-1">${formatDate(ev.event_date)}</p>
          `;
            badgeContainer.appendChild(card);
          });

        }
      } catch (err) {
        console.error("Error loading event badges:", err);
      }
    }

    function formatDate(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleDateString("en-US", {
        year: "numeric",
        month: "short",
        day: "numeric"
      });
    }

    function showToast(message, type = "success") {
      const toast = document.getElementById("toast");
      const toastMessage = document.getElementById("toast-message");
      const toastContent = document.getElementById("toast-content");

      toastMessage.textContent = message;

      if (type === "success") {
        toastContent.className = "flex items-center max-w-xs p-4 text-sm text-white bg-green-600 rounded-lg shadow-lg animate-slide-in";
        toastContent.querySelector("i").className = "fas fa-check-circle mr-2 text-white";
      } else if (type === "error") {
        toastContent.className = "flex items-center max-w-xs p-4 text-sm text-white bg-red-600 rounded-lg shadow-lg animate-slide-in";
        toastContent.querySelector("i").className = "fas fa-times-circle mr-2 text-white";
      }

      toast.classList.remove("hidden");

      // Auto-hide after 3 seconds
      setTimeout(() => {
        toast.classList.add("hidden");
      }, 1000);
    }

    // Profile picture upload function (uses FormData, so raw fetch)
    async function uploadProfilePicture(studentId) {
      const fileInput = document.getElementById("profile");
      const file = fileInput?.files?.[0];
      if (!file) return null;

      const formData = new FormData();
      formData.append("profile", file);

      try {
        const res = await fetch(`${API_BASE}/students/upload-profile/${studentId}`, {
          method: "POST",
          credentials: "include",
          body: formData
        });

        const result = await res.json();

        if (res.ok && result.success) {
          return result.data.path;
        } else {
          console.error(result.message || "Profile image upload failed.");
          return null;
        }
      } catch (error) {
        console.error("Error uploading profile picture:", error);
        return null;
      }
    }
  </script>


</body>

</html>